<div class="row" id="tedit">
  <div class="col-xs-3 col-md-2 sidebar" style="padding-top:5px;">
    <ul class="nav nav-sidebar">
      <li style="font-size:11px; text-transform:uppercase; font-weight:bold; color:#777; padding-left:5px;">unaudited days</li>
      <li v-for="day in unauditedDays" style="font-size:11px;">
        <% if @start_day.present? && @end_day.blank? %>
          <a href="/time/<%= @start_day %>?end_day={{ day.day }}">{{ day.day }}</a> <small>{{day.count}}</small>
        <% else %>
          <a href="/time/{{ day.day }}">{{ day.day }}</a> <small>{{day.count}}</small>
        <% end %>
      </li>
    </ul>
  </div>
  <div class="col-xs-9 col-md-10 main" style="width:100%;">
    <div v-if="alertMsg" class="alert alert-{{alertMsg.type}} fade in" id="flashmsgs" style="position:absolute;top:0px;right:0px;z-index:99999; padding:10px; min-height:52px;">
      <div class="text-center">{{alertMsg.msg}}</div>
    </div>

    <form method="POST" action="/time">
      <table class="table table-sm">
        <thead>
          <th class="payperiodgrp">PayDate</th>
          <th class="payperiodgrp">Start Date</th>
          <th class="payperiodgrp">End Date</th>
          <th class="payperiodgrp">&nbsp;</th>
          <!--
          <th>ID/Name Filter</th>
          <th></th>
          -->
        </thead>
        <tbody>
          <tr>
            <td class="payperiodgrp"><input name="pay_day" value="<%= @pay_day %>" placeholder="dd/mm/yyyy"></td>
            <td class="payperiodgrp"><input name="start_day" value="<%= @start_day %>" placeholder="dd/mm/yyyy"></td>
            <td class="payperiodgrp"><input name="end_day" value="<%= @end_day %>" placeholder="dd/mm/yyyy"></td>
            <td class="payperiodgrp"><input type="submit" class="btn btn-sm btn-primary" value="Set Dates"></input></td>
            <!--
            <td>
              <input v-model="idSearch" placeholder="ID" />
              <input v-model="nameSearch" placeholder="Name" />
            </td>
            <td><label style="font-size:11px; color:#777;"><input type="checkbox" v-model="showAll"> showAll</input></td>
            -->
          </tr>
        </tbody>
      </table>
    </form>

    <template v-for="employee in employees" track-by="id" data-entry-id="{{employee.id}}">
      <div style="font-size:12px; font-weight:bold;">
        <span style="color:#777">{{employee.employee_id}}</span> {{employee.name}}
        <a href="#" @click.prevent="addEntry(employee)" style="color:green; font-weight:bold;">+</a>
      </div>
      <table class="table table-striped table-sm">
        <thead>
          <tr>
            <th>Date</th>
            <th>
              <a href="#" @click.prevent="clearTime(employee,'start_time')" style="color:black; font-weight:bold;">In</a>
              /
              <a href="#" @click.prevent="clearTime(employee,'end_time')" style="color:black; font-weight:bold;">Out</a></th>
            <th>Lunch
              <a href="#" @click.prevent="clearTime(employee,'meal_start_time')" style="color:black; font-weight:bold;">In</a>
              /
              <a href="#" @click.prevent="clearTime(employee,'meal_end_time')" style="color:black; font-weight:bold;">Out</a></th>
            <th></th>
            <th>Rate</th>
            <th>Pieces</th>
            <th>Hours</th>
            <th>Amount</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="entry in employee.entries" track-by="id" data-entry-id="{{entry.id}}">
            <td>
              <span v-if="entry.in_agpay">{{entry.day}}</span>
              <input v-else v-model="entry.day" @keyup.enter="saveEntry(entry)" placeholder="yyyy-mm-dd">
            </td>
            <td>
              <input v-model="entry.start_time" @keyup.enter="saveEntry(entry)"  @change="copyTimes(employee,$index)" placeholder="in" style="width:49%">
              <input v-model="entry.end_time" @keyup.enter="saveEntry(entry)" @change="copyTimes(employee,$index)" placeholder="out" style="width:49%">
            </td>
            <td>
              <input v-model="entry.meal_start_time" @keyup.enter="saveEntry(entry)" @change="copyTimes(employee,$index)" placeholder="in" style="width:49%">
              <input v-model="entry.meal_end_time" @keyup.enter="saveEntry(entry)" @change="copyTimes(employee,$index)" placeholder="out" style="width:49%">
            </td>
            <td>
              <button v-on:click="saveEntry(entry)" class="btn btn-sm btn-primary-outline">Update</button>
              <button v-if="!entry.in_agpay" v-on:click="deleteEntry(employee, $index)" class="btn btn-sm btn-danger-outline">Del</button>
            </td>
            <td>
              <span v-if="entry.in_agpay">{{entry.rate}}</span>
              <input v-else v-model="entry.rate" @keyup.enter="saveEntry(entry)" placeholder="" size="2">
            </td>
            <td>
              <span v-if="entry.in_agpay">{{entry.pieces}}</span>
              <input v-else v-model="entry.pieces" @keyup.enter="saveEntry(entry)" placeholder="" size="3">
            </td>
            <td nowrap>
              <div v-if="entry.in_agpay">
                <small class="text-no-wrap" style="display:block">
                  pr {{entry.hours}}
                </small>
                <small class="text-no-wrap" v-bind:class="{ 'text-warning': (entry.hours != entry.timecard_hours) }" style="display:block">
                  tc {{entry.timecard_hours}}
                </small>
              </div>
              <input v-else v-model="entry.hours" @keyup.enter="saveEntry(entry)" placeholder="hours" size="3">
            </td>
            <td nowrap>
              <div v-if="entry.in_agpay">
                <small class="text-no-wrap" style="display:block">
                  pr {{entry.amount}}
                </small>
                <small class="text-no-wrap" v-bind:class="{ 'text-warning': (entry.amount != entry.timecard_amount) }" style="display:block">
                  tc {{entry.timecard_amount}}
                </small>
              </div>
              <input v-else v-model="entry.amount" @keyup.enter="saveEntry(entry)" placeholder="amount" size="3">
            </td>
            <td><input type="checkbox" v-model="entry.audited" v-bind:true-value="true"
    v-bind:false-value="false" v-on:click="saveEntryDelay(entry)"></td>
          </tr>
        </tbody>
      </table>
    </template>

  </div>
</div>

<script language="javascript">
var tedit = new Vue({
  el: '#tedit',
  data: {
    unauditedDays: <%= @unaudited_days.to_json.html_safe %>,
    employees:  <%= @employees.html_safe %>,
    showAll: false,
    nameSearch: "",
    idSearch: ""
  },
  computed: {
  },
  methods: {
    copyTimes: function(employee, $index) {
      var copyFields = ['start_time', 'end_time', 'meal_start_time', 'meal_end_time'],
          src = employee.entries[$index],
          vm = this;
      employee.entries.forEach(function(entry, index){
        if (entry.audited === true) { return; }
        if (index <= $index) { return; }
        if (entry.hours <= 5) { return; }
        var updated = false;
        copyFields.forEach(function(field){
          if (entry[field]!=null && entry[field].indexOf(':')>0) { return; }
          if (src[field]!=null && src[field].indexOf(':')>0) {
            updated = true;
            entry[field] = src[field]
          }
        });
        if (updated === true) { vm.saveEntry(entry); }
      });
    },
    clearTime: function(employee, col) {
      employee.entries.forEach(function(entry){
        entry[col] = '';
      });
    },
    saveEntry: function(e) {
      fetch('/time/'+e.id, {
        credentials: 'same-origin',
        method: 'PUT',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(e)
      }).then(function(r){
        return r.json();
      }).then(function(json) {
        Object.assign(e, json);
      });
    },
    saveEntryDelay: function(e) {
      var self = this;
      window.setTimeout(function(){
        self.saveEntry(e);
      },5);
      return true;
    },
    addEntry: function(employee){
      var entry = {};
      if (employee.entries.length>0) {
        Object.assign(entry, employee.entries[employee.entries.length-1]);
      }
      entry.id = "new"+entry.id; entry.audited = false; entry.in_agpay = false;
      employee.entries.push(entry);
    },
    deleteEntry: function(employee, index){
      var entry = employee.entries[index];
      fetch('/time/'+entry.id, {
        credentials: 'same-origin',
        method: 'DELETE'
      }).then(function(r){
        employee.entries.splice(index, 1);
        return;
      });
    }
  }

});
</script>
